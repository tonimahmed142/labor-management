<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>লেবার ব্যালান্স চার্ট</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-family: "Noto Sans Bengali", Arial, sans-serif; background:#fff; color:#222; padding:10px; }
  header { text-align:center; font-weight:600; font-size:1.2rem; margin-bottom:10px; }
  .chart-container { width:100%; overflow-x:auto; }
  canvas { background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; }
  .loading { text-align: center; padding: 20px; color: #666; }
  .error { text-align: center; padding: 20px; color: red; }
  .back-btn { margin-bottom: 15px; }
  @media(max-width:600px){ canvas { max-height:1200px; } }
</style>
</head>
<body>
<div class="back-btn">
  <button class="btn btn-sm btn-secondary" onclick="goBack()">← Back to Dashboard</button>
</div>
<header>লেবার মোট ব্যালান্স চার্ট</header>
<div id="loadingMessage" class="loading">ডাটা লোড হচ্ছে...</div>
<div id="errorMessage" class="error hidden"></div>
<div class="chart-container">
  <canvas id="balanceChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_BASE = 'https://labor-management.onrender.com'; // Same domain for Render deployment

// API call function
async function apiCall(endpoint, options = {}) {
  try {
    const response = await fetch(API_BASE + endpoint, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    showError('ডাটা লোড করতে সমস্যা হয়েছে: ' + error.message);
    throw error;
  }
}

// Load labor data from database
async function loadLaborData(){
  try {
    showLoading();
    const records = await apiCall('/api/records');
    hideLoading();
    return records;
  } catch (error) {
    hideLoading();
    return [];
  }
}

function showLoading() {
  document.getElementById('loadingMessage').classList.remove('hidden');
  document.getElementById('errorMessage').classList.add('hidden');
}

function hideLoading() {
  document.getElementById('loadingMessage').classList.add('hidden');
}

function showError(message) {
  document.getElementById('errorMessage').innerText = message;
  document.getElementById('errorMessage').classList.remove('hidden');
  document.getElementById('loadingMessage').classList.add('hidden');
}

function hideError() {
  document.getElementById('errorMessage').classList.add('hidden');
}

async function buildChart(){
  const records = await loadLaborData();
  
  if(!records || records.length === 0){ 
    showError('কোনো ডাটা পাওয়া যায়নি'); 
    return;
  }

  hideError();

  // Calculate total balance per worker (baki - jama)
  const map = {};
  records.forEach(r => {
    const name = r.name || 'Unknown';
    if(!map[name]) map[name] = 0;
    map[name] += (parseFloat(r.baki || 0) - parseFloat(r.jama || 0));
  });

  // Sort by balance (highest to lowest)
  const labels = Object.keys(map).sort((a,b) => map[b] - map[a]);
  const data = labels.map(l => map[l]);

  const ctx = document.getElementById('balanceChart').getContext('2d');
  const chartHeight = Math.max(400, labels.length * 40); // grows with number of labors
  document.getElementById('balanceChart').height = chartHeight;

  // Destroy existing chart if any
  if (window.balanceChartInstance) {
    window.balanceChartInstance.destroy();
  }

  window.balanceChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'মোট ব্যালান্স',
        data: data,
        backgroundColor: data.map(v => v < 0 ? 'rgba(255,99,132,0.6)' : 'rgba(54,162,235,0.6)'),
        borderColor: data.map(v => v < 0 ? 'rgba(255,99,132,1)' : 'rgba(54,162,235,1)'),
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y', // horizontal bars
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          beginAtZero: true, 
          title: {
            display: true,
            text: 'ব্যালান্স (টাকা)'
          },
          ticks: {
            callback: function(value) {
              return '৳' + value.toLocaleString('bn-BD');
            }
          }
        },
        y: { 
          title: {
            display: true,
            text: 'শ্রমিকের নাম'
          },
          ticks: {
            autoSkip: false,
            maxRotation: 0,
            minRotation: 0
          }
        }
      },
      plugins: {
        legend: { 
          display: false 
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const status = value < 0 ? 'দেনা' : (value > 0 ? 'পাওনা' : 'শূন্য');
              return `${status}: ৳${Math.abs(value).toFixed(2)}`;
            },
            title: function(tooltipItems) {
              return tooltipItems[0].label;
            }
          }
        },
        datalabels: {
          anchor: 'end',
          align: function(context) {
            return context.raw < 0 ? 'left' : 'right';
          },
          color: function(context) {
            return context.raw < 0 ? '#d63031' : '#2d3436';
          },
          font: { 
            weight: 'bold',
            size: 12
          },
          formatter: function(value) {
            const prefix = value < 0 ? '-' : '';
            return prefix + '৳' + Math.abs(value).toFixed(2);
          },
          offset: 8
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// Navigation
function goBack() {
  window.location.href = '/';
}

// Load Chart.js datalabels plugin dynamically
const script = document.createElement('script');
script.src = "https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2";
script.onload = buildChart;
document.head.appendChild(script);

// Handle page visibility changes (refresh chart when returning to page)
document.addEventListener('visibilitychange', function() {
  if (!document.hidden && window.balanceChartInstance) {
    // Refresh data when page becomes visible again
    setTimeout(async () => {
      const records = await loadLaborData();
      if (records && records.length > 0) {
        buildChart();
      }
    }, 100);
  }
});

// Auto-refresh every 30 seconds
setInterval(async () => {
  if (!document.hidden) {
    const records = await loadLaborData();
    if (records && records.length > 0) {
      buildChart();
    }
  }
}, 30000);
</script>

<style>
.hidden { display: none; }
.loading { text-align: center; padding: 20px; font-size: 16px; }
.error { 
  text-align: center; 
  padding: 20px; 
  color: #d63031; 
  background: #ffeaa7; 
  border-radius: 8px; 
  margin: 10px 0;
}
</style>
</body>
</html>